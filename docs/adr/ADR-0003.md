# ADR-0003: Hybrid Retrieval and Metrics

Status: Accepted

Problem
- Pure vector retrieval may miss exact-match signals and suffers when embeddings are imperfect. We also need basic observability to monitor latency and errors without exposing sensitive data.

Options
1. Vector-only (status quo): simplest but may underperform on keyword-heavy queries.
2. BM25-only: robust for keywords but ignores semantics.
3. Hybrid fusion (BM25 + vector): combine signals with a weighted sum; compute BM25 on vector candidates to limit cost.

Decision
- Implement v1 hybrid: retrieve topN (HYBRID_TOPN, default 50) vector candidates, score the same texts with BM25 (rank_bm25), fuse normalized scores with weight HYBRID_WEIGHT (default 0.6). If candidate count is too small, expand candidate set.
- Add Prometheus metrics via `prometheus-fastapi-instrumentator`, expose `/metrics` when `ENABLE_METRICS=true`. Add a custom counter `rag_rerank_timeouts_total` for reranker timeouts.
- Keep labels free from PII; avoid putting user inputs into labels.

Implications
- Latency: fusion adds BM25 on up to N texts (cheap). Reranker remains optional with a timeout; on timeout we fall back and increment a counter.
- Tunables: `HYBRID_ENABLED`, `HYBRID_WEIGHT`, `HYBRID_TOPN` control behavior. Can be overridden per request by `{"hybrid": true|false}`.
- Cold start: warmup loads embeddings early; reranker import is checked. Health now includes `models_ready`.

Defaults
- ENABLE_METRICS=true, HYBRID_ENABLED=false, HYBRID_WEIGHT=0.6, HYBRID_TOPN=50, EVAL_TOP_K=5, WARMUP_MODELS=true

